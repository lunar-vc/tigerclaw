## Flox Environment Manifest — Tigerclaw VC Research
## https://flox.dev/docs/reference/command-reference/manifest.toml/
version = 1

## Packages ----------------------------------------------------------------
[install]
nodejs_22.pkg-path = "nodejs_22"
git.pkg-path = "git"
curl.pkg-path = "curl"
jq.pkg-path = "jq"
ripgrep.pkg-path = "ripgrep"
wget.pkg-path = "wget"

## Static Environment Variables --------------------------------------------
[vars]
NODE_ENV = "development"
PUPPETEER_SKIP_DOWNLOAD = "true"

## Activation Hook (bash) --------------------------------------------------
[hook]
on-activate = '''
  # --- 1. Load .env ------------------------------------------------------
  if [ -f "$FLOX_ENV_PROJECT/.env" ]; then
    set -a
    source "$FLOX_ENV_PROJECT/.env"
    set +a
    echo "  Loaded .env"
  else
    echo "  WARNING: No .env file found — copy .env.example to .env and fill in your keys"
  fi

  # --- 2. Detect Chrome / Chromium for Puppeteer --------------------------
  CHROME_FOUND=""

  # Linux: check if Flox provided chromium
  if command -v chromium >/dev/null 2>&1; then
    export PUPPETEER_EXECUTABLE_PATH="$(command -v chromium)"
    CHROME_FOUND="chromium (Flox)"
  fi

  # macOS: check Puppeteer cache
  if [ -z "$CHROME_FOUND" ]; then
    PUPPETEER_CACHE="$HOME/.cache/puppeteer"
    CHROME_MAC="$PUPPETEER_CACHE/chrome/mac_arm-*/chrome-mac-arm64/Google Chrome for Testing.app/Contents/MacOS/Google Chrome for Testing"
    CHROME_MAC_X86="$PUPPETEER_CACHE/chrome/mac-*/chrome-mac-x64/Google Chrome for Testing.app/Contents/MacOS/Google Chrome for Testing"
    for candidate in $CHROME_MAC $CHROME_MAC_X86; do
      if [ -x "$candidate" ]; then
        export PUPPETEER_EXECUTABLE_PATH="$candidate"
        CHROME_FOUND="Puppeteer cache"
        break
      fi
    done
  fi

  # Fallback: system Chrome on macOS
  if [ -z "$CHROME_FOUND" ]; then
    SYSTEM_CHROME="/Applications/Google Chrome.app/Contents/MacOS/Google Chrome"
    if [ -x "$SYSTEM_CHROME" ]; then
      export PUPPETEER_EXECUTABLE_PATH="$SYSTEM_CHROME"
      CHROME_FOUND="system Chrome"
    fi
  fi

  if [ -n "$CHROME_FOUND" ]; then
    echo "  Chrome: $CHROME_FOUND"
  else
    echo "  WARNING: No Chrome found. Run: npx puppeteer browsers install chrome"
  fi

  # --- 3. Clone / update agent-skills ------------------------------------
  SKILLS_TARGET="$FLOX_ENV_PROJECT/.claude/skills/agent-skills"
  if [ -d "$SKILLS_TARGET/.git" ]; then
    git -C "$SKILLS_TARGET" pull --quiet 2>/dev/null && echo "  Agent skills: updated" || echo "  Agent skills: present (pull failed, offline?)"
  else
    mkdir -p "$(dirname "$SKILLS_TARGET")"
    if git clone --quiet https://github.com/lunar-vc/agent-skills.git "$SKILLS_TARGET" 2>/dev/null; then
      echo "  Agent skills: cloned"
    else
      echo "  WARNING: Could not clone agent-skills (check network / GITHUB_TOKEN)"
    fi
  fi

  # --- 4. Ensure research directory exists --------------------------------
  mkdir -p "$FLOX_ENV_PROJECT/research"

  # --- 5. Create tigerclaw launcher in env bin ----------------------------
  mkdir -p "$FLOX_ENV_CACHE/bin"
  cat > "$FLOX_ENV_CACHE/bin/tigerclaw" << 'LAUNCHER'
#!/usr/bin/env bash
printf '\n'
printf '  \033[38;5;208m╱\033[38;5;214m╱\033[38;5;220m╱\033[0m        \033[1;37mTiger Claw\033[0m\n'
printf '   \033[38;5;208m╱\033[38;5;214m╱\033[38;5;220m╱\033[0m       \033[2mAgentic VC Research\033[0m\n'
printf '    \033[38;5;208m╱\033[38;5;214m╱\033[38;5;220m╱\033[0m      \033[2m%s\033[0m\n' "$(pwd)"
printf '\n'
exec claude "$@"
LAUNCHER
  chmod +x "$FLOX_ENV_CACHE/bin/tigerclaw"
  export PATH="$FLOX_ENV_CACHE/bin:$PATH"

  # --- 6. Export dynamic env vars -----------------------------------------
  export TIGERCLAW_HOME="$FLOX_ENV_PROJECT"
  export SKILLS_DIR="$FLOX_ENV_PROJECT/.claude/skills/agent-skills"
  export RESEARCH_DIR="$FLOX_ENV_PROJECT/research"

  # --- 7. Post-activate validation ------------------------------------------
  TC_WARNINGS=0
  if [ ! -f "$FLOX_ENV_PROJECT/.env" ]; then
    TC_WARNINGS=$((TC_WARNINGS + 1))
  fi
  if [ -z "$CHROME_FOUND" ]; then
    TC_WARNINGS=$((TC_WARNINGS + 1))
  fi
  if [ ! -d "$FLOX_ENV_PROJECT/.claude/skills/agent-skills/.git" ]; then
    TC_WARNINGS=$((TC_WARNINGS + 1))
  fi

  # --- 8. Welcome banner (in hook to avoid p10k instant prompt conflict) ---
  echo ""
  echo "=== Tiger Claw — Agentic VC Research ==="
  echo "  Node : $(node --version)"
  echo ""
  echo "Quick start:"
  echo "  tigerclaw               — Launch Tiger Claw"
  echo "  tigerclaw-doctor        — Check environment health"
  echo "  skills                  — List available agent skills"
  echo "  search-founders <query> — Run latent founder signal scan"
  echo "  post-hookdeck <payload> — Post event to Hookdeck"
  echo ""
  if [ "$TC_WARNINGS" -gt 0 ]; then
    echo "  ⚠ $TC_WARNINGS issue(s) detected — run tigerclaw-doctor for details"
    echo ""
  fi
'''

## Profile (sourced by your shell) -----------------------------------------
[profile]
common = '''
  # Aliases
  alias skills="ls -1 $FLOX_ENV_PROJECT/.claude/skills/agent-skills/"
  alias search-founders="node $FLOX_ENV_PROJECT/.claude/skills/agent-skills/latent-founder-signals/scripts/search.js"
  alias post-hookdeck="node $FLOX_ENV_PROJECT/.claude/skills/agent-skills/hookdeck/scripts/post.js"
  alias tigerclaw-doctor="bash $FLOX_ENV_PROJECT/scripts/doctor.sh"
'''

## Options -----------------------------------------------------------------
[options]
systems = ["aarch64-darwin", "x86_64-linux", "aarch64-linux"]
