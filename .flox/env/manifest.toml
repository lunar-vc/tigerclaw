## Flox Environment Manifest — Tigerclaw VC Research
## https://flox.dev/docs/reference/command-reference/manifest.toml/
version = 1

## Packages ----------------------------------------------------------------
[install]
# Core runtime
nodejs_22.pkg-path = "nodejs_22"
git.pkg-path = "git"

# CLI tools
gh.pkg-path = "gh"
curl.pkg-path = "curl"
jq.pkg-path = "jq"
ripgrep.pkg-path = "ripgrep"
wget.pkg-path = "wget"
bc.pkg-path = "bc"

# Session / pane infrastructure
tmux.pkg-path = "tmux"
fswatch.pkg-path = "fswatch"

# AI CLIs (used by linkedin-fetch, reddit-fetch skills via tmux)
gemini-cli.pkg-path = "gemini-cli"

# Chromium for Puppeteer MCP (Linux only; macOS uses system Chrome)
chromium.pkg-path = "chromium"
chromium.systems = ["x86_64-linux", "aarch64-linux"]

## Static Environment Variables --------------------------------------------
[vars]
NODE_ENV = "development"
PUPPETEER_SKIP_DOWNLOAD = "true"

## Activation Hook (bash) --------------------------------------------------
[hook]
on-activate = '''
  # --- 1. Load .env ------------------------------------------------------
  if [ -f "$FLOX_ENV_PROJECT/.env" ]; then
    set -a
    source "$FLOX_ENV_PROJECT/.env"
    set +a
    echo "  Loaded .env"
  else
    echo "  WARNING: No .env file found — copy .env.example to .env and fill in your keys"
  fi

  # --- 2. Detect Chrome / Chromium for Puppeteer --------------------------
  CHROME_FOUND=""

  # Linux: check if Flox provided chromium
  if command -v chromium >/dev/null 2>&1; then
    export PUPPETEER_EXECUTABLE_PATH="$(command -v chromium)"
    CHROME_FOUND="chromium (Flox)"
  fi

  # macOS: check Puppeteer cache
  if [ -z "$CHROME_FOUND" ]; then
    PUPPETEER_CACHE="$HOME/.cache/puppeteer"
    CHROME_MAC="$PUPPETEER_CACHE/chrome/mac_arm-*/chrome-mac-arm64/Google Chrome for Testing.app/Contents/MacOS/Google Chrome for Testing"
    CHROME_MAC_X86="$PUPPETEER_CACHE/chrome/mac-*/chrome-mac-x64/Google Chrome for Testing.app/Contents/MacOS/Google Chrome for Testing"
    for candidate in $CHROME_MAC $CHROME_MAC_X86; do
      if [ -x "$candidate" ]; then
        export PUPPETEER_EXECUTABLE_PATH="$candidate"
        CHROME_FOUND="Puppeteer cache"
        break
      fi
    done
  fi

  # Fallback: system Chrome on macOS
  if [ -z "$CHROME_FOUND" ]; then
    SYSTEM_CHROME="/Applications/Google Chrome.app/Contents/MacOS/Google Chrome"
    if [ -x "$SYSTEM_CHROME" ]; then
      export PUPPETEER_EXECUTABLE_PATH="$SYSTEM_CHROME"
      CHROME_FOUND="system Chrome"
    fi
  fi

  if [ -n "$CHROME_FOUND" ]; then
    echo "  Chrome: $CHROME_FOUND"
  else
    echo "  WARNING: No Chrome found. Run: npx puppeteer browsers install chrome"
  fi

  # --- 3. Install npm dependencies if needed ----------------------------
  if [ -f "$FLOX_ENV_PROJECT/package.json" ] && [ ! -d "$FLOX_ENV_PROJECT/node_modules" ]; then
    echo "  Installing npm dependencies..."
    (cd "$FLOX_ENV_PROJECT" && npm install --no-fund --no-audit --silent 2>/dev/null) && echo "  npm: installed" || echo "  WARNING: npm install failed"
  elif [ -d "$FLOX_ENV_PROJECT/node_modules" ]; then
    echo "  npm: node_modules present"
  fi

  # --- 4. Clone / update agent-skills ------------------------------------
  SKILLS_TARGET="$FLOX_ENV_PROJECT/.claude/skills/agent-skills"
  if [ -d "$SKILLS_TARGET/.git" ]; then
    git -C "$SKILLS_TARGET" pull --quiet 2>/dev/null && echo "  Agent skills: updated" || echo "  Agent skills: present (pull failed, offline?)"
  else
    mkdir -p "$(dirname "$SKILLS_TARGET")"
    if git clone --quiet https://github.com/lunar-vc/agent-skills.git "$SKILLS_TARGET" 2>/dev/null; then
      echo "  Agent skills: cloned"
    else
      echo "  WARNING: Could not clone agent-skills (check network / GITHUB_TOKEN)"
    fi
  fi

  # --- 5. Auto-pull latest from origin (fast-forward only) ---------------
  if git -C "$FLOX_ENV_PROJECT" rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    git -C "$FLOX_ENV_PROJECT" pull --ff-only --quiet 2>/dev/null &
    PULL_PID=$!
  fi

  # --- 6. Ensure research + data directories exist ----------------------
  mkdir -p "$FLOX_ENV_PROJECT/research"
  mkdir -p "$FLOX_ENV_PROJECT/data/graph"

  # --- 6. Create tigerclaw launcher in env bin ----------------------------
  mkdir -p "$FLOX_ENV_CACHE/bin"
  cat > "$FLOX_ENV_CACHE/bin/tigerclaw" << LAUNCHER
#!/usr/bin/env bash
exec bash "$FLOX_ENV_PROJECT/scripts/tigerclaw-launch.sh" "\$@"
LAUNCHER
  chmod +x "$FLOX_ENV_CACHE/bin/tigerclaw"
  export PATH="$FLOX_ENV_CACHE/bin:$PATH"

  # --- 7. Export dynamic env vars -----------------------------------------
  export TIGERCLAW_HOME="$FLOX_ENV_PROJECT"
  export SKILLS_DIR="$FLOX_ENV_PROJECT/.claude/skills/agent-skills"
  export RESEARCH_DIR="$FLOX_ENV_PROJECT/research"

  # --- 8. Post-activate validation ------------------------------------------
  TC_WARNINGS=0
  if [ ! -f "$FLOX_ENV_PROJECT/.env" ]; then
    TC_WARNINGS=$((TC_WARNINGS + 1))
  fi
  if [ -z "$CHROME_FOUND" ]; then
    TC_WARNINGS=$((TC_WARNINGS + 1))
  fi
  if [ ! -d "$FLOX_ENV_PROJECT/.claude/skills/agent-skills/.git" ]; then
    TC_WARNINGS=$((TC_WARNINGS + 1))
  fi
  # Check gh auth
  if ! gh auth status >/dev/null 2>&1; then
    TC_WARNINGS=$((TC_WARNINGS + 1))
  fi
  # Check gemini auth
  if ! command -v gemini >/dev/null 2>&1; then
    TC_WARNINGS=$((TC_WARNINGS + 1))
  fi

  # --- 9. Report pull result ----------------------------------------------
  if [ -n "${PULL_PID:-}" ]; then
    if wait "$PULL_PID" 2>/dev/null; then
      BEHIND=$(git -C "$FLOX_ENV_PROJECT" rev-list --count HEAD..@{u} 2>/dev/null || echo 0)
      if [ "$BEHIND" -gt 0 ]; then
        echo "  \033[38;5;220m⚠ $BEHIND commit(s) behind origin (pull skipped — not fast-forwardable)\033[0m"
        echo ""
      fi
    else
      echo "  \033[38;5;220m⚠ Auto-pull failed (diverged or offline) — run: git pull\033[0m"
      echo ""
    fi
  fi

  # --- 10. Welcome banner (in hook to avoid p10k instant prompt conflict) --
  ORANGE='\033[38;5;208m'
  AMBER='\033[38;5;214m'
  YELLOW='\033[38;5;220m'
  WHITE='\033[1;37m'
  BOLD='\033[1m'
  DIM='\033[2m'
  GREY='\033[38;5;240m'
  RST='\033[0m'

  echo ""
  source "$FLOX_ENV_PROJECT/scripts/logo.sh"
  echo ""
  printf "  Node   : $(node --version)\n"
  printf "  gh     : $(gh --version 2>/dev/null | head -1 | awk '{print $3}' || echo 'not found')\n"
  printf "  gemini : $(gemini --version 2>/dev/null || echo 'not found')\n"
  echo ""
  printf "  ${WHITE}Quick start${RST}\n"
  printf "  ${DIM}tigerclaw${RST}               — Launch tmux\n"
  printf "  ${DIM}tigerclaw --new${RST}         — Spawn additional session\n"
  printf "  ${DIM}tigerclaw-doctor${RST}        — Check environment health\n"
  printf "  ${DIM}skills${RST}                  — List available agent skills\n"
  printf "  ${DIM}search-founders <query>${RST} — Run latent founder scan\n"
  echo ""
  if [ "$TC_WARNINGS" -gt 0 ]; then
    printf "  ${YELLOW}⚠ $TC_WARNINGS issue(s) detected — run tigerclaw-doctor${RST}\n"
    echo ""
  fi
'''

## Profile (sourced by your shell) -----------------------------------------
[profile]
common = '''
  # Aliases
  alias skills="ls -1 $FLOX_ENV_PROJECT/.claude/skills/agent-skills/"
  alias search-founders="node $FLOX_ENV_PROJECT/.claude/skills/agent-skills/latent-founder-signals/scripts/search.js"
  alias post-hookdeck="node $FLOX_ENV_PROJECT/.claude/skills/agent-skills/hookdeck/scripts/post.js"
  alias tigerclaw-doctor="bash $FLOX_ENV_PROJECT/scripts/doctor.sh"
  alias tigerclaw-new="bash $FLOX_ENV_PROJECT/scripts/tigerclaw-launch.sh --new"
  log-discovery() { printf "[$(date +%H:%M)] %s\n" "$*" >> "$FLOX_ENV_PROJECT/.discoveries"; }
'''

## Options -----------------------------------------------------------------
[options]
systems = ["aarch64-darwin", "x86_64-linux", "aarch64-linux"]
